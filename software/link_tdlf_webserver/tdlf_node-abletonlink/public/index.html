<html>

    <head>
        <meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width">
        <!--<meta name="viewport" content="width=device-width, initial-scale=1">-->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <style> body {padding: 0; margin: 0;} </style>
    </head>
<body>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/p5.min.js" type="text/javascript"></script>
    <script src ="js/p5.touchgui.js" type="text/javascript"></script>
   
    <script>

        let isOpen = false;
        var gui; // p5.touchgui
  
        let plus;
        let minus;

        var socket = io();
        var myBeat = 42;
        var myBPM = 66.6;

        //var myPhase = 0;
        var numUsers = 0;
        let step = 0;
        let monStep = 0;
        let bar = 0;
        let myMidiIndex = 0; 

        let base = 32; // button x offset from edge
        let sx = base; // text x offset idem
        let sy = 10;
        let off = 28;
        let boff = 62 // button offset
        let trowy = 110;
        let browy = 172;
        let hbutton = 30;
        let vbutton = 23;
        let bsize = 60;
        var myPlayState;

        let eric_X = 118+555;
        let eric_Y = 129;
        
        var output;
    
        let data;
        let note;

        //let ccData = ['s',120,42];

        let ccData = ['s',eric_X,eric_Y];

        
        let mstr = new Array(79); // Array to send to the node.js server
        for (let i = 0; i < mstr.length; i++) {
            mstr[i] = false;
            // console.log(mstr[i]);
        }

        let mtmss = new Array(632);   // 79 x 8 array to store the 8 instruments 
        for (let i = 0; i < mtmss.length; i++) {
            mtmss[i] = false;
            // console.log(mtmss[i]);
        }

        let pitons = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p"];
        let instr = ["   bd  ", " snare ", "low tom", " hi tom", " cl hat", " op hat", "  clap ", " claves"]
        let myInstr = 0;
        let midiChannel = 1;

        function touchMoved() { // prevent scrolling on mobile devices
            // do some stuff
            return false;
        }

        function noteEncode(note) { // broken, I don't know why charAt(i) crashes 

            let tmpTotal = note.toString(2);
            console.log ("note : "+note);
            console.log ("note in binary : "+note.toString(2));
            for (i = 0;i<3;i++){
                mtmss[4+i] = tmpTotal.charAt(i);
                //console.log ("tmpTotal : "+tmpTotal.charAt(i));
            }
        }  
        
        function midiEncode(myMidiIndex) { // broken, I don't know why charAt(i) crashes 
             
            let tmpTotal = midiChannel.toString(2);
            console.log ("midiChannel : "+midiChannel);
            console.log ("midiChannel in binary :"+tmpTotal);
            for (i = 0;i<3;i++){
                mtmss[i] = tmpTotal.charAt(i);
                //console.log ("tmpTotal :"+tmpTotal.charAt(i));
            }
        } 

        function setup() {
            createCanvas(windowWidth,windowHeight);
            setMoveThreshold(0.1);

            // img = loadImage('freeliner.jpg'); // Load the image
           
            gui = createGui();
            gui.loadStyle("Rose");
            gui.setStrokeWeight(4);
            
            a = createButton("0",base+0*boff,trowy, bsize, bsize);
            b = createButton("1",base+1*boff,trowy, bsize, bsize);
            c = createButton("2",base+2*boff,trowy, bsize, bsize);
            d = createButton("3",base+3*boff,trowy, bsize, bsize);
            e = createButton("4",base+4*boff,trowy, bsize, bsize);
            f = createButton("5",base+5*boff,trowy, bsize, bsize);
            g = createButton("6",base+6*boff,trowy, bsize, bsize);
            h = createButton("7",base+7*boff,trowy, bsize, bsize);

            i = createButton("8",base+0*boff,browy, bsize, bsize);
            j = createButton("9",base+1*boff,browy, bsize, bsize);
            k = createButton("10",base+2*boff,browy, bsize, bsize);
            l = createButton("11",base+3*boff,browy, bsize, bsize);
            m = createButton("12",base+4*boff,browy, bsize, bsize);
            n = createButton("13",base+5*boff,browy, bsize, bsize);
            o = createButton("14",base+6*boff,browy, bsize, bsize);
            p = createButton("15",base+7*boff,browy, bsize, bsize);

            minus = createButton("-", sx+55, sy+2*off-16, hbutton, vbutton);
            plus = createButton("+", sx+150, sy+2*off-16, hbutton, vbutton);

            //startStop = createButton("Start/Stop", sx+130, sy+3*off-16, 20, 20);

            minusBar = createButton("-", sx+350, sy+off-16, hbutton,vbutton);
            plusBar = createButton("+", sx+465, sy+off-16, hbutton,vbutton);

            minusMidi = createButton("-", sx+350, sy+2*off-16, hbutton, vbutton);
            plusMidi = createButton("+", sx+465, sy+2*off-16, hbutton, vbutton);

            minusInstr= createButton("-", sx+350, sy+3*off-16, hbutton, vbutton);
            plusInstr = createButton("+", sx+465, sy+3*off-16, hbutton, vbutton);

            // Callbacks can also be assigned to existing, user-defined functions.
            for(x = 0; x < 16 ; x++){
                eval(pitons[x]).onRelease = nouvCol;  
                }

            let noLabelStyle = { 
                fillLabel: color(230, 145, 0),
                fillLabelHover: color(250,145,250),
                fillLabelActive: color(250, 210, 250)
            };

            for(x = 0; x < 16 ; x++){
                eval(pitons[x]).setStyle(noLabelStyle); 
                }

            background(25);
            noLoop(); // don't update draw
        } // end of setup

        function nouvCol() {
            print(this.label + " is pressed.");
            let numberPressed = int(this.label); // Otherwise it contatenates a number as text
            console.log("numberPressed : " +numberPressed);
            mtmss[numberPressed+15+(myInstr*79)] = !mtmss[numberPressed+15+(myInstr*79)];  // write the notes in their right place
            mstr[numberPressed+15] = mtmss[numberPressed+15+(myInstr*79)];  // write the notes in their right place
            
            console.log("myInstr : "+myInstr);

            // get the myInstr value, use as multiplicator to write to the correct part of the database
            // send that mstr (79) values part of the database to the node.js server to relay to the tdlf server.
            
            //////////// fix noteEncode for an elegant solution ////
            if (myInstr == 7){
                mstr[4] = true;  // 1
                mstr[5] = true;  // 2
                mstr[6] = true;  // 4
                mstr[7] = false; // 8
            }
            else if (myInstr == 6){
                mstr[4] = false;  
                mstr[5] = true;  
                mstr[6] = true;  
                mstr[7] = false;  
            }
            else if (myInstr == 5){
                mstr[4] = true;  
                mstr[5] = false;  
                mstr[6] = true;  
                mstr[7] = false;  
            }
            else if (myInstr == 4){
                mstr[4] = false;  
                mstr[5] = false;  
                mstr[6] = true; 
                mstr[7] = false;  
            }
            else if (myInstr == 3){
                mstr[4] = true;  
                mstr[5] = true;  
                mstr[6] = false;
                mstr[7] = false;  
            }
            else if (myInstr == 2){
                mstr[4] = false;  
                mstr[5] = true;  
                mstr[6] = false;  
                mstr[7] = false;  
            }
            else if (myInstr == 1){
                mstr[4] = true;  
                mstr[5] = false;  
                mstr[6] = false;  
                mstr[7] = false;  
            }
            else if (myInstr == 0){
                mstr[4] = false;  
                mstr[5] = false;  
                mstr[6] = false;  
                mstr[7] = false; 
            } 


            ////// midi channel encoding /// fix midiEncode() for an elegant solution...

            if (midiChannel-1 == 15){  
                mstr[0] = true;  // 1
                mstr[1] = true;  // 2
                mstr[2] = true;  // 4
                mstr[3] = true;  // 8
            }

            else if (midiChannel-1 == 14){  
                mstr[0] = false; // 1 
                mstr[1] = true; // 2  
                mstr[2] = true; // 4  
                mstr[3] = true; // 8   
            }

            else if (midiChannel-1 == 13){  
                mstr[0] = true;  // 1
                mstr[1] = false; // 2
                mstr[2] = true;  // 4
                mstr[3] = true;  // 8
            }

            else if (midiChannel-1 == 12){  
                mstr[0] = false; // 1 
                mstr[1] = false;  // 2
                mstr[2] = true;  // 4
                mstr[3] = true;  // 8
            }

            else if (midiChannel-1 == 11){  
                mstr[0] = true;  // 1 
                mstr[1] = true;  // 2
                mstr[2] = false; // 4 
                mstr[3] = true;  // 8
            }

            else if (midiChannel-1 == 10){  
                mstr[0] = false;  // 1  
                mstr[1] = true;   // 2
                mstr[2] = false;  // 4
                mstr[3] = true;   // 8
            }
            
            else if (midiChannel-1 == 9){  
                mstr[0] = true;  
                mstr[1] = false;  
                mstr[2] = false;  
                mstr[3] = true;  
            }
            else if (midiChannel-1 == 8){  
                mstr[0] = false;  
                mstr[1] = false;  
                mstr[2] = false;  
                mstr[3] = true;  
            }
            else if (midiChannel-1 == 7){ 
                mstr[0] = true;  
                mstr[1] = true;  
                mstr[2] = true;  
                mstr[3] = false;  
            }
            else if (midiChannel-1 == 6){
                mstr[0] = false;  
                mstr[1] = true;  
                mstr[2] = true;  
                mstr[3] = false;  
            }
            else if (midiChannel-1 == 5){
                mstr[0] = true;  
                mstr[1] = false;  
                mstr[2] = true;  
                mstr[3] = false;  
            }
            else if (midiChannel-1 == 4){
                mstr[0] = false;  
                mstr[1] = false;  
                mstr[2] = true;  
                mstr[3] = false;  
            }
            else if (midiChannel-1 == 3){
                mstr[0] = true;  
                mstr[1] = true;  
                mstr[2] = false;  
                mstr[3] = false;  
            }
            else if (midiChannel-1 == 2){
                mstr[0] = false;  
                mstr[1] = true;  
                mstr[2] = false;  
                mstr[3] = false;  
            }
            
            else if (midiChannel-1 == 1){
                mstr[0] = true;  
                mstr[1] = false;  
                mstr[2] = false;  
                mstr[3] = false;  
            }
            
            else if (midiChannel-1 == 0){
                mstr[0] = false;  
                mstr[1] = false;  
                mstr[2] = false;  
                mstr[3] = false; 
            }


            //////////// fix noteEncode for an elegant solution, problem seems to be using for loops here ////
            
            /* for(i=15;i<32;i++){ // just get the 16 steps of interest
                mstr[i] = mtmss[i+myInstr*79];
            } */ // this doesn't work, no llips allowed...

            data = mstr;

            // console.log("mstr : "+mstr);
            socket.emit('interface', data);
        }

        socket.on('numUsers', function(data) {
            numUsers = data.numUsers;
        });
    
        //socket.on('test', function(data) { // trying to get the playState
        //myPlayState = data.test;
        //console.log("test : "+myPlayState);
        //});
    
        // handle the event sent with socket.send()
        socket.on("message", (data) => {
           // console.log("mon step : "+data);
            step = data;
            //console.log("step là : "+step);
            // change border color fo the active button
            

          for(x = 0; x < 16 ; x++){
            
            if(mtmss[x+15+(myInstr*79)]==true){
                eval(pitons[x]).setStyle("fillBg", color(250, 210, 250)); 
                eval(pitons[x]).setStyle("fillLabel", color(240, 210, 250));

            }
            else{
            eval(pitons[x]).setStyle("fillBg", color("#DD8806")); 
            eval(pitons[x]).setStyle("fillLabel", color("#DD8810"));
            }

        }
        
        //console.log("pitons[step] : "+pitons[step]);
        //console.log("  ");
        eval(pitons[step]).setStyle("fillBg", color(120, 255, 255));
        eval(pitons[step]).setStyle("fillLabel", color(253, 250, 253));
      
        redraw();
        
        });

        socket.on('beat', function(data) {
            //console.log("data : "+data);
            myBeat = data.beat;
            //console.log("myBeat : "+myBeat);
            myBPM = data.bpm;
            //console.log("myBPM : "+myBPM);
            myBPM = myBPM.toFixed(2);
            //myPhase = data.phase;
            //myPhase = myPhase.toFixed(1);
            
            redraw();
        });
    
            
        function draw(){ // simple interface done in p5.js
            clear();
            background(70,50,70);
            //image(img, 0, 0);
            fill("#111111");
            rect(5,5,545,245,20);
            rect(555,5,250,245,20);
            rect(5,255,800,150,20);
            drawGui();


            fill("#DDBB44");
            textSize(18);

            if(mouseX > 555 && mouseX < 800 && mouseY > 5 && mouseY < 250) {

                // console.log("oh yeah!!)");
                // console.log(mouseX);
                // console.log(mouseY);
                //stroke(255,255,0);
                //text('Éric', mouseX, mouseY);
                //ellipse(mouseX,mouseY,30,30);
                rect(mouseX,mouseY-10,4,24);
                rect(mouseX-10,mouseY,24,4);
                
                // save mouseX y mouseY when mouse is down
              
                if (mouseIsPressed) {
                    //stroke(255);
                    eric_X = mouseX-555;
                    eric_Y = mouseY-5;
                    console.log("eric_X : "+eric_X);
                    console.log("eric_Y : "+eric_Y);

                    ccData = [42,eric_X,eric_Y];

                    data = ccData;
                    socket.emit('CCData', data);
                }

                rect(eric_X+555,eric_Y-10+5,4,24);
                rect(eric_X-10+555,eric_Y+5,24,4);


                
               

            }
          
            text('technologies de la fête', sx, sy+off);
            text('BPM :        '+myBPM, sx, sy+2*off);
            text('clients :               '+numUsers, sx, sy+3*off);
            
            // text('beat :        '+myBeat, sx, sy+2*off);
            // text('Start/Stop', sx, sy+3*off);
            // text('phase :     '+round(myPhase), sx, sy+4*off);
            
            text('bar :                          '+bar, sx+250, sy+off );
            text('midi :                       '+midiChannel, sx+250, sy+2*off);
            text('instrument :          '+instr[myInstr], sx+250, sy+3*off);

            //text('step :        '+step, sx+300, sy+4*off);

            /* if (a.isPressed){
                print("seq but 0 pressed."); 
                data =  { bpm:1 }; 
                socket.emit('mtmss', data);
            }
            else if (b.isPressed){
                print("seq but 0 pressed.");
                data =  { bpm:1 }; 
                socket.emit('mtmss', data); 
            } */
  
            if (minus.isPressed) {
            // Print a message when Button is pressed.
            print(minus.label + " pressed.");
            data =  { bpm:-1 };
                socket.emit('chBPM', data);
            }
            if (plus.isPressed) {
            // Print a message when Button is pressed.
            print(plus.label + " pressed.");
            data =  { bpm:1 };
           // var data =  { isPlaying:false };
           socket.emit('chBPM', data);
            }

            if (plusBar.isPressed) {
                bar = bar+1;
                if(bar == 5){
                    bar = 4; // the maximum
                }
            }
            if (minusBar.isPressed) {
                bar = bar-1;
                if(bar == 0){
                    bar = 1; // the minimum
                }
            }

            if (plusMidi.isPressed) {
                midiChannel =midiChannel +1;
                if (midiChannel == 17){
                    midiChannel = 1; // the maximum
                }
                print("Midi Channel : "+midiChannel);
                //midiEncode(myMidiIndex);
    
            }
            if (minusMidi.isPressed) {
                midiChannel = midiChannel -1;
                if (midiChannel == 0){
                    midiChannel = 16; // the minimum
                }
                print("Midi Channel : "+midiChannel);
                //midiEncode(myMidiIndex);
    
            }

            if (plusInstr.isPressed) {
                myInstr++;

                if (myInstr == instr.length){
                    myInstr = 0 ;
                }

              // load the right data into mstr !
              // no for loop as that results in a weird error
              mstr[15] = mtmss[myInstr*79+15];
              mstr[16] = mtmss[myInstr*79+16];
              mstr[17] = mtmss[myInstr*79+17];
              mstr[18] = mtmss[myInstr*79+18];
              mstr[19] = mtmss[myInstr*79+19];
              mstr[20] = mtmss[myInstr*79+20];
              mstr[21] = mtmss[myInstr*79+21];
              mstr[22] = mtmss[myInstr*79+22];
              mstr[23] = mtmss[myInstr*79+23];
              mstr[24] = mtmss[myInstr*79+24];
              mstr[25] = mtmss[myInstr*79+25];
              mstr[26] = mtmss[myInstr*79+26];
              mstr[27] = mtmss[myInstr*79+27];
              mstr[28] = mtmss[myInstr*79+28];
              mstr[29] = mtmss[myInstr*79+29];
              mstr[30] = mtmss[myInstr*79+30];

                console.log("myInstr : "+myInstr);
                //noteEncode(myInstr);
            }

            if (minusInstr.isPressed) {
                myInstr--;
                if (myInstr == -1){
                    myInstr = instr.length-1; 
                }

              mstr[15] = mtmss[myInstr*79+15];
              mstr[16] = mtmss[myInstr*79+16];
              mstr[17] = mtmss[myInstr*79+17];
              mstr[18] = mtmss[myInstr*79+18];
              mstr[19] = mtmss[myInstr*79+19];
              mstr[20] = mtmss[myInstr*79+20];
              mstr[21] = mtmss[myInstr*79+21];
              mstr[22] = mtmss[myInstr*79+22];
              mstr[23] = mtmss[myInstr*79+23];
              mstr[24] = mtmss[myInstr*79+24];
              mstr[25] = mtmss[myInstr*79+25];
              mstr[26] = mtmss[myInstr*79+26];
              mstr[27] = mtmss[myInstr*79+27];
              mstr[28] = mtmss[myInstr*79+28];
              mstr[29] = mtmss[myInstr*79+29];
              mstr[30] = mtmss[myInstr*79+30];
                console.log("myInstr : "+myInstr);
                //noteEncode(myInstr);
            }
            
           /*  if (startStop.isPressed) {
                data =  true;
                socket.emit('startStop', data);
                console.log("start/stop")
            } */

        } // fin de draw


    /*function deviceMoved() {

        //rx = map(rotationX, -90, 90, 0, displayHeight);
        //ry = map(rotationY, -90, 90, 0, displayWidth);
        //rz = radians(rotationZ);
        text("rotated", 50,50);
        }
    */

    </script>
</body>
</html>
